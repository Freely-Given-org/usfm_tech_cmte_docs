= Character Marker Nesting

== Background

*In USFM*, xref:char:index.adoc[character] level markup is applied to a span of text within a containing xref:para:index.adoc[paragraph]. In some texts, the USFM markup required to identify the content will require nesting one character level marker within another character level marker. In these situations a USFM editor, processor, or publishing system must understand how to interpret or display the nested markup contexts. In some editors (e.g. Paratext), the start of a new character level marker is interpreted as an implicit closure of the the previous character environment. If the intent is to nest the inner character markup, the meaning or formatting applied to the outer marker layer applies to the inner level also. The inner markup adds additional meaning and formatting for the nested text.

The most common occurrence for nested character markup is within footnotes, where text occurring within a footnote quotation (\fq), keyword (\fk), or the footnote text (\ft), requires further markup.

*In USX*, nested elements occur in XML normally without requiring any additional syntax.

== Indicating markup is nested

*In USFM*, add a plus sign `+` as a prefix to the opening and closing forms of a nested marker pair to indicate that a nested character environment is starting. The `+` is added after the backslash, and before the marker text.

In the following example text:
* `\+nd` indicates to start a new character environment nested inside the existing `\add` environment (without closing `\add`)
* `\+nd*` indicates to end the nested environment without closing `\add`

[source#src-char-nesting_1,usfm]
----
The following is a \add translator's addition containing 
the word \+nd Lord\+nd* within it\add*
----

All new character marker starts (without the + prefix) close all existing nesting. The next two examples are both valid nested character markup.

[source#src-char-nesting_2,usfm]
----
\p ... \add an addition containing the word \+nd Lord\+nd*\add* and 
further text ...
----

[source#src-char-nesting_3,usfm]
----
\p ... \add an addition containing the word \+nd Lord\add* and further 
text ...
----

If necessary, multiple levels of nesting character markup can occur.

== Examples

.USFM: Numbers 21.14 (GNT) - \bk \+nd nested
[source#src-char-nesting_4,usfm,highlight=1]
----
\v 14 That is why \bk The Book of the \+nd Lord\+nd*'s Battles\bk* speaks of 
“...the town of Waheb in the area of Suphah, and the valleys; the Arnon River,
\v 15 and the slope of the valleys that extend to the town of Ar and toward 
the border of Moab.”
----

image::char/bknd-nested_1.jpg[Numbers 21.14 (GNT) - \bk \+nd nested,300]

.USFM: Genesis 2.4 (GNT) - \fk and \ft \+nd nested
[source#src-char-nesting_5,usfm,highlight=2;4]
----
\s1 The Garden of Eden
\p When the \nd Lord\nd* \f + \fr 2.4: \fk the \+nd Lord\+nd*: \ft Where the 
Hebrew text has Yahweh, traditionally transliterated as Jehovah, this 
translation employs \+nd Lord\+nd* with capital letters, following a usage 
which is widespread in English versions.\f* God made the universe,
\v 5 there were no plants on the earth and no seeds had sprouted, because he 
had not sent any rain, and there was no one to cultivate the land;
----

image::char/fknd-nested_1.jpg[Genesis 2.4 (GNT) - \fk and \ft \+nd nested,600]

.USX: Genesis 2.4 (GNT) - <char style="nd"> within <char style="fk"> 
[source#src-usx-char-nesting_5,xml,highlight=2;4]
----
<para style="s" vid="GEN 2:4">The Garden of Eden</para>
<para style="p" vid="GEN 2:4">When the <char style="nd">Lord</char>
  <note caller="+" style="f">
    <char style="fr" closed="false">2.4: </char>
    <char style="fk" closed="false">the 
      <char style="nd">Lord</char>: 
    </char>
    <char style="ft" closed="false">Where the Hebrew text has Yahweh, 
      traditionally transliterated as Jehovah, this translation employs 
      <char style="nd">Lord</char>
      with capital letters, following a usage which is widespread in 
      English versions.
    </char>
  </note> God made the universe, <verse eid="GEN 2:4" />
  <verse number="5" style="v" sid="GEN 2:5" />there were no plants on the earth 
  and no seeds had sprouted, because he had not sent any rain, and there was no 
  one to cultivate the land;<verse eid="GEN 2:5" />
</para>
----
